<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

 
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    game.load.spritesheet('noob', 'assets/noob.png', 70, 55);

    game.load.image('monstre', 'assets/monstre.png',32, 48);
    game.load.image('monstre_saute', 'assets/monstre2.png');
    game.load.image('sky', 'assets/fond1.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('star', 'assets/axel.png');
    game.load.image('sang', 'assets/sang.png');
    game.load.image('axel_troll', 'assets/axel2.png');
    game.load.image('restart', 'assets/restart.png');
    game.load.image('boule_feu', 'assets/boule_feu.png');

    game.load.audio('main_music', 'assets/audio/bakermat_black_cat.mp3');
    game.load.audio('audio_coin', 'assets/audio/p-ping.mp3');
    game.load.audio('audio_shot', 'assets/audio/shotgun.wav');
    game.load.audio('audio_jump', 'assets/audio/jump.wav');
    game.load.audio('audio_dead', 'assets/audio/dead.wav');
    


}

var player;
var monstres;
var platforms;
var cursors;

var stars;
var score = 0;
var scoreText;
var textFin;
var blood;
var end =false;

var axel =false;
var dec =true;

var bruit_coin;
var bruit_jump;
var bruit_dead;
var music;

var btnRestart;

// --------------------------------------------------------------------------------------//

function create() {

 // Ground et platforme

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    game.add.sprite(0, 0, 'sky');

    platforms = game.add.group();

    platforms.enableBody = true;

    var ground = platforms.create(0, game.world.height - 10, 'ground');

    ground.scale.setTo(2, 2);

    ground.body.immovable = true;

    var platform = platforms.create(40, 400, 'ground');
    platform.body.immovable = true;

    platform = platforms.create(-150, 250, 'ground');
    platform.body.immovable = true;

//Stars
    //  Finally some stars to collect
    stars = game.add.group();
    //  We will enable physics for any star that is created in this group
    stars.enableBody = true;

//Monstre
    monstres = game.add.group();
    monstres.enableBody = true;

// Create the elements
    createStars();
    createMonsters();
    createPlayer();

//  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
//  The score
    scoreText = game.add.text(game.world.width-150 , 0, '0 POINT', { fontSize: '60px', fill: '#000' });
    textFin = game.add.text(0 ,0, '', { fontSize: '200px', fill: '#000' });

//The Sound
    bruit_jump = game.add.audio('audio_jump');
    bruit_dead = game.add.audio('audio_dead');
    bruit_coin = game.add.audio('audio_coin');
    music = game.add.audio('main_music');
    music.play();

}

// --------------------------------------------------------------------------------------//
function update() {
   
    game.physics.arcade.collide(stars, platforms);
    game.physics.arcade.collide(player, platforms);
    game.physics.arcade.collide(monstres, platforms);

    game.physics.arcade.overlap(player, monstres, dead, null, this);
    game.physics.arcade.overlap(player, stars, collectStar, null, this);

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;

    if (cursors.left.isDown && end==false)
    {
        //  Move to the left
        player.body.velocity.x = -150;

        player.animations.play('left');
    }
    else if (cursors.right.isDown && end==false)
    {
        //  Move to the right
        player.body.velocity.x = 150;

        player.animations.play('right');
    }
    else
    {
        //  Stand still
        player.animations.stop();

        player.frame = 4;
    }
    
    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown && player.body.touching.down && end==false)
    {
        bruit_jump.play();
        player.body.velocity.y = -580;
    }


}

// --------------------------------------------------------------------------------------//

function createStars(){
    //  Here we'll create 12 of them evenly spaced apart
    for (var i = 0; i < 12; i++)
    {
        //  Create a star inside of the 'stars' group
        var star = stars.create(i * 70, 0, 'star');

        //  Let gravity do its thing
        star.body.gravity.y = 300;

        //  This just gives each star a slightly random bounce value
        star.body.bounce.y = 0.7 + Math.random() * 0.2;
    }
}

function createMonsters(){
    for (var i = 1; i < 2; i++)
    {
        var monstre = monstres.create(i * 600, game.world.height - 300, 'monstre_saute');
        monstre.body.gravity.y = 100;
        monstre.body.bounce.y = 1;
    }
}
function createPlayer(){
    player = game.add.sprite(32, game.world.height - 60, 'dude');
    game.physics.arcade.enable(player);

    player.body.bounce.y = 0.1;
    player.body.gravity.y = 800;
    player.body.collideWorldBounds = true;

    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);
}

function dead (player, monstre) {
    
    player.kill();
    bruit_dead.play();
    music.stop();
    gameOver("lose");

}

function collectStar (player, star) {
    
    star.kill();
    bruit_coin.play();
    score += 1;
    if(score ==1)
    {
        scoreText.text = score + ' POINT ';
    }
    else
    {
         scoreText.text = score + ' POINTS ';
    }

    if(score==12)
    {
        gameOver('win');
    }

}

function teteAxel() {
    
    axel= game.add.sprite(400, 600, 'axel_troll');
    game.add.tween(axel).to({ y: 340 }, 400, Phaser.Easing.Linear.None, true);

}

function gameOver(statut)
{
    end = true;
    //Remove all
        stars.removeAll();
        monstres.removeAll();
        player.kill();
    if(statut=="win")
    {
        //textFin.text ="Tu as mangé toutes les têtes d'Axel !";
        teteAxel();
    }
    else
    {  
        //Remove all
        stars.removeAll();
        //Blood
        blood = game.add.sprite(0, -100, 'sang');
        game.add.tween(blood.scale).to( { x: 1.2, y: 1.2 }, 200, Phaser.Easing.Linear.None, true);

        //EndTitle
        for (var i = 0; i < 4; i++)
        {
            endTitle = game.add.sprite(270+ 69 * i, -1000, 'noob', i);
            game.add.tween(endTitle).to({y: 240}, 2000, Phaser.Easing.Bounce.Out, true, 1000 + 400 * i, false);
        }
    }
    //bouton Restart
        //Création du bouton
        btnRestart = game.add.sprite(game.world.centerX-65, game.world.centerY, 'restart');
        //Active le clic sur le bouton
        btnRestart.inputEnabled = true;
        //Rajoute un event clic au bouton qui va appeler la méthode restart
        btnRestart.events.onInputDown.add(restart, this);
}

function restart(){

    btnRestart.destroy();
    scoreText.destroy();
    resetScore();

    if(axel!=false)
    {
        axel.destroy();
    }
    else
    {
        blood.destroy();
       // there is a bug with the deleting endTitle
        endTitle.kill();
    }

    createStars();
    createMonsters();
    createPlayer();
    end=false;
    axel=false;
}
function resetScore(){
    score = 0;
    scoreText = game.add.text(game.world.width-150 , 0, '0 POINT', { fontSize: '60px', fill: '#000' });
}

</script>

</body>
</html>